# 基本設計書：YouTube Timestamped Notes

## 1. システム概要

### 1.1 目的
YouTube動画の視聴中に重要なポイントを**タイムスタンプ付きで記録**し、記録したメモから**動画の特定時点にすぐにジャンプ**できるようにすることで、学習・リサーチ効率を向上させる。

### 1.2 システムの特徴
- **ローカル完結型**: すべてのデータはローカルストレージに保存され、外部サーバーへの送信なし
- **シームレスな統合**: YouTubeページ上に直接UIを表示し、視聴中にメモを取れる
- **SPA対応**: YouTubeのSingle Page Application構造に対応した動画遷移検知
- **軽量設計**: Manifest V3のService Workerモデルにより、リソース消費を最小化

### 1.3 対象環境
- **ブラウザ**: Google Chrome（Manifest V3対応版）
- **対象サイト**: YouTube（`www.youtube.com/watch*`）
- **動作条件**: インターネット接続（YouTubeへのアクセスに必要）

## 2. 機能設計

### 2.1 機能一覧

| No. | 機能名 | 概要 | 実装場所 |
|:---|:---|:---|:---|
| 1 | **メモの作成・保存** | 現在の動画ID、再生時間、動画タイトル、メモを保存する。ページ内フォームまたはポップアップから実行可能。 | Content Script / Popup / Storage |
| 2 | **ページ内メモ表示** | 動画視聴ページ上に、その動画に紐づくメモの一覧を表示する。折り畳み機能付き。 | Content Script |
| 3 | **ページ内ジャンプ** | ページ内のメモのタイムスタンプをクリックすると、動画を指定の秒数まで移動させる。 | Content Script |
| 4 | **グローバルメモ一覧** | オプションページとして全動画のメモ一覧を表示し、そこから動画に直接ジャンプさせる。 | Options Page / Storage / Tabs API |
| 5 | **メモの削除** | 各メモ項目からメモを削除できる。確認ダイアログ表示。 | Content Script |
| 6 | **データ永続化** | 全てのメモデータをブラウザのローカルストレージに永続的に保存する。 | Storage API |

### 2.2 機能詳細

#### 2.2.1 メモの作成・保存
- **入力方法**:
  - ページ内フォーム: 動画ページ上に表示される「＋ メモ追加」ボタンから
  - ポップアップ: 拡張機能アイコンをクリックして表示されるポップアップから
- **自動取得情報**: 動画ID、再生時間、動画タイトル
- **保存データ**: メモテキスト、タイムスタンプ（秒単位）、表示用時刻文字列（"MM:SS"形式）、作成日時
- **データ管理**: 動画IDをキーとして管理、メモは時間順に自動ソート

#### 2.2.2 ページ内メモ表示
- **表示位置**: 動画プレーヤーの下、説明欄の上
- **表示内容**: メモ件数、各メモのタイムスタンプと内容
- **UI機能**: 折り畳み/展開ボタン、メモ追加ボタン、削除ボタン
- **自動更新**: 動画遷移時に自動的に現在の動画のメモ一覧に更新

#### 2.2.3 タイムスタンプジャンプ
- **ページ内ジャンプ**: メモのタイムスタンプボタンをクリック → `video.currentTime`を設定
- **グローバルジャンプ**: オプションページから → 新しいタブで動画を指定時間から再生
- **視覚的フィードバック**: ジャンプ時にアニメーション表示

#### 2.2.4 グローバルメモ一覧
- **表示方法**: 動画ごとにグループ化、メモ件数表示
- **ソート**: 動画内のメモは時間順、全メモは作成日時順（新しい順）
- **ジャンプ機能**: タイムスタンプボタンで新しいタブを開いて動画を再生

## 3. データ設計

### 3.1 データ構造

#### 3.1.1 ストレージ構造
```javascript
{
  // キー: 動画ID（例: "dQw4w9WgXcQ"）
  "dQw4w9WgXcQ": {
    "title": "動画タイトル",
    "notes": [
      {
        "time": 120,                    // 秒単位の再生時間
        "text": "メモ内容",              // メモテキスト
        "timestamp_text": "02:00",      // 表示用の時刻文字列（"MM:SS"形式）
        "createdAt": 1704067200000      // 作成日時（Unixタイムスタンプ、ミリ秒）
      }
    ]
  }
}
```

#### 3.1.2 データ項目定義

| 項目名 | 型 | 説明 | 制約 |
|:---|:---|:---|:---|
| `videoId` | `string` | 動画ID（URLパラメータ`v`の値） | 必須、一意 |
| `title` | `string` | 動画タイトル | 保存時のタイトルを保持 |
| `notes` | `Array<Note>` | メモ配列 | 時間順にソート |
| `Note.time` | `number` | 再生時間（秒） | 0以上の数値 |
| `Note.text` | `string` | メモ内容 | 空文字列不可 |
| `Note.timestamp_text` | `string` | 表示用時刻（"MM:SS"形式） | "MM:SS"形式 |
| `Note.createdAt` | `number` | 作成日時（ミリ秒） | Unixタイムスタンプ |

### 3.2 データフロー

```
[ユーザー入力]
    ↓
[メモ保存処理]
    ↓
[データ検証・整形]
    ↓
[chrome.storage.local.set()]
    ↓
[ストレージ保存]
    ↓
[UI更新通知]
    ↓
[メモ一覧再描画]
```

### 3.3 データライフサイクル

1. **作成**: ユーザーがメモを入力 → バリデーション → ストレージに保存
2. **読み取り**: ページ読み込み時または動画遷移時 → ストレージから取得 → UIに表示
3. **更新**: メモ追加時 → 既存データに追加 → 時間順にソート → 保存
4. **削除**: ユーザーが削除ボタンをクリック → 確認 → ストレージから削除 → UI更新
5. **クリーンアップ**: メモが0件になった動画データは自動削除

## 4. インターフェース設計

### 4.1 コンポーネント間通信

#### 4.1.1 Popup ↔ Content Script
- **通信方式**: `chrome.tabs.sendMessage()` / `chrome.runtime.onMessage`
- **メッセージ形式**:
  ```javascript
  // リクエスト
  { action: 'getVideoInfo' }
  { action: 'refreshNotes' }
  
  // レスポンス
  { videoId: string, currentTime: number, videoTitle: string }
  { error: string }
  { success: true }
  ```

#### 4.1.2 Content Script ↔ YouTube DOM
- **操作対象**: `<video>`要素、ページ構造要素
- **主要操作**:
  - 動画要素取得: `document.querySelector('video')`
  - 再生時間設定: `video.currentTime = seconds`
  - UI挿入: `insertAdjacentElement()`, `appendChild()`

#### 4.1.3 Options Page ↔ Storage
- **通信方式**: `chrome.storage.local` API
- **操作**: `get()`, `set()`, `remove()`, `onChanged`リスナー

### 4.2 外部API

#### 4.2.1 Chrome Extension APIs
- **chrome.storage.local**: データ永続化
- **chrome.tabs**: タブ操作（新規タブで動画を開く）
- **chrome.runtime**: 拡張機能間通信

#### 4.2.2 YouTube API
- **使用なし**: YouTube APIは使用せず、DOM操作のみで実現

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **初期化時間**: ページ読み込み後500ms以内にメモ一覧を表示開始（最大10回試行）
- **UI応答性**: メモ追加・削除操作は1秒以内に完了
- **メモリ使用量**: 軽量設計（Service Workerモデル採用）
- **ストレージ容量**: ローカルストレージの制限内（通常5-10MB）

### 5.2 可用性要件
- **動作環境**: Google Chrome（Manifest V3対応版）
- **依存サービス**: YouTube（外部依存）
- **データ保持**: ブラウザのローカルストレージに永続化（ブラウザデータ削除まで保持）

### 5.3 セキュリティ要件
- **データプライバシー**: すべてのデータはローカルに保存、外部送信なし
- **権限最小化**: 必要な権限のみを要求（`storage`, `tabs`, YouTubeドメインのみ）
- **XSS対策**: HTMLエスケープ処理を実装（Options Page）

### 5.4 保守性要件
- **コード構造**: 機能ごとにファイル分割、明確な責務分離
- **エラーハンドリング**: try-catchによる適切なエラー処理
- **ログ**: 開発者ツールでのデバッグを想定

## 6. 制約事項・前提条件

### 6.1 技術的制約
- **Manifest V3必須**: Chrome拡張機能の最新仕様に準拠
- **YouTube DOM構造依存**: YouTubeのDOM構造変更により動作に影響を受ける可能性
- **SPA対応**: YouTubeのSingle Page Application構造に対応する必要がある
- **ブラウザ依存**: Google Chrome専用（他のChromium系ブラウザでも動作する可能性はあるが非保証）

### 6.2 機能制約
- **動画IDベース管理**: 同じ動画でもURLが異なる場合（プレイリストからのURLなど）は別メモとして扱われる
- **ローカルストレージ制限**: ブラウザのストレージ容量制限に依存
- **データバックアップ**: 現在のバージョンではエクスポート機能なし（将来実装予定）

### 6.3 運用制約
- **手動インストール**: Chrome Web Store未公開のため、手動インストールが必要
- **更新手動**: 更新時は手動で再読み込みが必要
- **データ移行**: バージョンアップ時の自動データ移行機能なし

## 7. エラーハンドリング設計

### 7.1 エラー分類

#### 7.1.1 軽微なエラー（ユーザーに影響なし）
- **ストレージ取得エラー**: 静かに処理、空データとして扱う
- **DOM要素取得失敗**: 再試行またはスキップ

#### 7.1.2 警告レベルのエラー（ユーザーに通知）
- **動画情報取得失敗**: エラーメッセージ表示、保存ボタン無効化
- **メモ保存失敗**: アラート表示、ボタン状態を復元

#### 7.1.3 致命的なエラー（機能停止）
- **YouTubeページでない**: エラーメッセージ表示、機能無効化

### 7.2 エラー処理方針
- **フォールバック機能**: 複数の方法で要素取得を試行（セレクタパターンの多様化）
- **再試行機構**: 初期化時の遅延読み込み（最大10回、500ms間隔）
- **ユーザーフレンドリー**: 技術的なエラーメッセージではなく、分かりやすいメッセージを表示

## 8. 運用設計

### 8.1 インストール手順
1. リポジトリをクローンまたはダウンロード
2. Chromeで`chrome://extensions/`を開く
3. デベロッパーモードをON
4. 「パッケージ化されていない拡張機能を読み込む」をクリック
5. `extension`フォルダを選択

### 8.2 更新手順
1. 新しいバージョンのファイルで置き換え
2. `chrome://extensions/`で拡張機能の「更新」ボタンをクリック
3. または、拡張機能を無効化→有効化

### 8.3 トラブルシューティング
- **メモが表示されない**: ページをリロード、拡張機能が有効か確認
- **タイムスタンプボタンが動作しない**: 動画が読み込まれているか確認
- **データが保存されない**: ストレージ権限を確認、ストレージ容量を確認

## 9. 🛠️ 技術要素

### 技術スタック
- **プラットフォーム**: Google Chrome Extension
  - **選定理由**: YouTubeページのDOMに直接アクセスして動画要素を操作し、ページ上にメモUIを注入できる。
- **Manifest Version**: 3（最新仕様）
  - **選定理由**: Service Workerモデルにより軽量で、YouTubeのSPA遷移検知に適している。Googleが推奨する最新仕様で将来の互換性を確保。
- **言語**: JavaScript (ES6+)
  - **選定理由**: ブラウザ拡張機能の標準言語で、DOM操作や非同期処理（`async/await`）が容易。ビルドツール不要で開発がシンプル。
- **スタイリング**: CSS3
  - **選定理由**: YouTubeの既存デザインに自然に統合できるカスタムスタイルを実装。Flexboxでレイアウト、アニメーションでUXを向上。
- **マークアップ**: HTML5
  - **選定理由**: Content Scriptで動的に生成するUI要素の構造化に使用。セマンティックな要素でアクセシビリティを確保。

### アーキテクチャ

#### コンポーネント構成
1. **Content Script** (`content.js`)
   - YouTubeページに直接注入されるスクリプト
   - 動画ページ上にメモ一覧UIを動的に生成・表示
   - 動画の再生時間取得、タイムスタンプジャンプ機能を実装
   - YouTubeのSPA（Single Page Application）構造に対応した動画遷移検知機能

2. **Popup** (`popup.html`, `popup.js`)
   - 拡張機能アイコンクリック時に表示されるポップアップ
   - 現在の動画情報取得とメモ保存機能を提供
   - Content Scriptとのメッセージパッシングで連携

3. **Options Page** (`options.html`, `options.js`)
   - 全動画のメモを一元管理するページ
   - グローバルメモ一覧表示と動画ジャンプ機能

4. **Background Service Worker** (`background.js`)
   - バックグラウンドでの処理を担当
   - 拡張機能のライフサイクル管理

#### 主要な技術実装

**データ永続化**
- `chrome.storage.local` APIを使用してメモデータをローカルストレージに保存
- 動画IDをキーとして、各動画のメモを管理
- データ構造: `{ videoId: { title: string, notes: Array<{time, text, timestamp_text, createdAt}> } }`

**動画遷移検知**
- `MutationObserver`によるDOM変更監視
- `popstate`イベントによるブラウザ履歴変更検知
- `history.pushState`/`replaceState`のオーバーライドによる内部ナビゲーション検知
- 定期的な動画IDチェックによるフォールバック機能

**UI動的生成**
- 動画ページ上へのカスタムUI挿入
- SVG要素内への誤挿入を防ぐ検証機能
- 折り畳み/展開機能付きのインタラクティブUI
- インラインでのメモ追加フォーム表示

**メッセージパッシング**
- `chrome.runtime.sendMessage`によるContent ScriptとPopup間の通信
- 非同期レスポンス処理

**YouTube DOM操作**
- YouTubeの動的コンテンツ読み込みに対応した遅延初期化
- 複数のセレクタパターンによる確実な要素挿入
- 動画要素の取得と再生時間制御

### ファイル構成
```
extension/
├── manifest.json          # 拡張機能の設定ファイル
├── icons/                 # アイコンファイル
│   ├── icon16.png        # 16x16ピクセル
│   ├── icon48.png        # 48x48ピクセル
│   └── icon128.png       # 128x128ピクセル
├── js/
│   ├── background.js     # Service Worker
│   ├── content.js        # Content Script（メインロジック）
│   ├── options.js        # オプションページのロジック
│   └── popup.js          # ポップアップのロジック
├── css/
│   ├── content.css       # ページ内UIのスタイル
│   ├── options.css       # オプションページのスタイル
│   └── popup.css         # ポップアップのスタイル
└── html/
    ├── options.html       # オプションページ
    └── popup.html         # ポップアップUI
```

### セキュリティ・プライバシー
- **データ保存**: すべてのデータはローカルストレージに保存され、外部サーバーには送信されません
- **権限最小化**: 必要な権限は最小限（`storage`, `tabs`, YouTubeドメインへのアクセス）
- **プライバシー保護**: ユーザーの動画視聴データは完全にローカルで管理されます
- **XSS対策**: Options PageでHTMLエスケープ処理を実装
- **権限の透明性**: manifest.jsonで必要な権限を明示的に宣言

## 10. まとめ

### 10.1 設計のポイント
- **シンプルなアーキテクチャ**: 4つの主要コンポーネントで構成、責務が明確
- **ローカル完結型**: 外部サーバー不要、プライバシー保護
- **SPA対応**: YouTubeの動的なページ遷移に対応
- **ユーザビリティ重視**: ページ内フォームでシームレスな操作

### 10.2 今後の拡張可能性
- メモのエクスポート/インポート機能
- メモの検索・フィルタリング機能
- メモの編集機能
- メモのカテゴリ分類
- メモの共有機能（将来的に外部サービス連携）
- データのクラウド同期（オプション）

### 10.3 関連ドキュメント
- [要件定義書](要件定義書.md): システムの目的と機能要件
- [README.md](../README.md): ユーザー向けドキュメント

